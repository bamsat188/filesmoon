<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Filesmoon</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;background:#000;color:#fff;font-family:system-ui}
header{padding:14px 20px;background:#000;border-bottom:1px solid #222}
.logo{color:#e50914;font-weight:700;font-size:22px}
.container{max-width:1100px;margin:auto;padding:16px}
.player{display:none;background:#000;border-radius:16px;overflow:hidden;margin-bottom:16px;position:relative}
.player iframe{width:100%;height:520px;border:0}
@media(max-width:768px){.player iframe{height:260px}}
#playerOverlay{position:absolute;inset:0;cursor:pointer}
.video-info{display:none;margin-bottom:20px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:14px}
.card{background:#111;border-radius:12px;cursor:pointer;overflow:hidden}
.thumb{padding-top:56%;background:#222;display:flex;align-items:center;justify-content:center}
.thumb span{color:#e50914;font-weight:700}
.title{padding:10px;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pagination{text-align:center;margin:20px}
.pagination a{padding:10px 16px;background:#222;color:#fff;border-radius:8px;text-decoration:none}
</style>
</head>

<body>

<header>
  <div class="logo">Filesmoon</div>
</header>

<div class="container">

  <div id="playerBox" class="player">
    <iframe id="player" allowfullscreen allow="autoplay"></iframe>
    <div id="playerOverlay"></div>
  </div>

  <div id="videoInfo" class="video-info">
    <h2 id="videoTitle">–</h2>
    <small id="videoDate">–</small>
  </div>

  <div id="videos" class="grid"></div>
  <div id="pagination" class="pagination"></div>

</div>

<script>
/* ================= CONFIG ================= */
const API = "https://filemoonapi.com/api/file/list?key=107242cw1es4xgd2p0u04j";
const PER_PAGE = 12;
const TITLE_CACHE = {};

/* ================= VAR ================= */
let FILES = [];
let PAGE = parseInt(new URLSearchParams(location.search).get("page")||"1");

/* ================= DOM ================= */
const list = document.getElementById("videos");
const pagination = document.getElementById("pagination");
const playerBox = document.getElementById("playerBox");
const player = document.getElementById("player");
const overlay = document.getElementById("playerOverlay");
const videoInfo = document.getElementById("videoInfo");
const videoTitle = document.getElementById("videoTitle");
const videoDate = document.getElementById("videoDate");

/* ================= API ================= */
async function fetchPage(page){
  const res = await fetch(`${API}&page=${page}`, { cache:"no-store" });
  const json = await res.json();
  return json?.result?.files || [];
}

/* ================= FIND META ================= */
async function findVideoMeta(id, maxPage=10){
  if(TITLE_CACHE[id]) return TITLE_CACHE[id];

  for(let p=1;p<=maxPage;p++){
    const files = await fetchPage(p);
    if(!files.length) break;

    const found = files.find(v=>v.file_code===id);
    if(found){
      TITLE_CACHE[id] = found;
      return found;
    }
  }
  return null;
}

/* ================= RENDER ================= */
function renderCard(v){
  const el = document.createElement("div");
  el.className="card";
  el.innerHTML=`
    <div class="thumb"><span>VIDEO</span></div>
    <div class="title">${v.title||"Untitled"}</div>
  `;
  el.onclick=()=>location.hash=`/e/${v.file_code}`;
  list.appendChild(el);
}

/* ================= PLAYER ================= */
async function openVideo(id){
  player.src = `https://filemoon.to/e/${id}`;
  playerBox.style.display="block";
  videoInfo.style.display="block";
  videoTitle.textContent="Loading title...";

  const meta = await findVideoMeta(id);
  if(meta){
    videoTitle.textContent = meta.title || "Untitled";
    videoDate.textContent = meta.uploaded || "–";
  }else{
    videoTitle.textContent = "Untitled";
  }
}

/* ================= ROUTE ================= */
function handleRoute(){
  const m = location.hash.match(/#\/e\/([\w]+)/);
  if(!m) return;
  openVideo(m[1]);
}

/* ================= LOAD ================= */
async function loadHome(){
  FILES = await fetchPage(PAGE);
  list.innerHTML="";
  FILES.slice(0,PER_PAGE).forEach(renderCard);

  pagination.innerHTML = `
    <a href="?page=${PAGE+1}" onclick="PAGE++;loadHome();return false">
      Load More →
    </a>`;
}

/* ================= INIT ================= */
overlay.onclick=()=>overlay.style.display="none";
window.addEventListener("hashchange",handleRoute);

loadHome();
handleRoute();
</script>

</body>
</html>
